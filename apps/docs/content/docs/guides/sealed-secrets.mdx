---
title: Sealed Secrets
description: Encrypt environment variables with ECIES encryption
---

# Sealed Secrets Guide

This guide explains how to securely store sensitive environment variables like API keys using ECIES (Elliptic Curve Integrated Encryption Scheme) encryption.

## Overview

Sealed secrets ensure that:

- **API keys** are never stored in plaintext
- **Secrets** are encrypted at rest in `morpheus.yaml`
- **Only your deployment** can decrypt them
- **Git-safe** - Encrypted values can be committed

## How It Works

```
┌─────────────────────────────────────────────────────────────────┐
│                         Sealing Process                          │
│  ┌──────────────┐                          ┌──────────────────┐ │
│  │  Plaintext   │    ECIES Encryption      │  Sealed Secret   │ │
│  │  API_KEY=    │ ─────────────────────▶   │  sealed:v1:...   │ │
│  │  sk-abc123   │    (Your Public Key)     │                  │ │
│  └──────────────┘                          └──────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ Stored in morpheus.yaml
                              │ Safe to commit to Git
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Deployment Process                         │
│  ┌──────────────────┐                      ┌──────────────────┐ │
│  │  Sealed Secret   │  ECIES Decryption    │    Plaintext     │ │
│  │  sealed:v1:...   │ ─────────────────▶   │    API_KEY=      │ │
│  │                  │  (Your Private Key)  │    sk-abc123     │ │
│  └──────────────────┘                      └──────────────────┘ │
│                                                     │            │
│                                                     ▼            │
│                                            ┌──────────────────┐ │
│                                            │    Container     │ │
│                                            │  Environment     │ │
│                                            └──────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```

## Step 1: Seal Your Secrets

### Interactive Mode

```bash
morpheus env seal

# Output:
# ? Enter variable name: ANTHROPIC_API_KEY
# ? Enter secret value: ************************************
#
# ✓ Secret sealed successfully!
#
# Add this to your morpheus.yaml:
#
# env:
#   ANTHROPIC_API_KEY: sealed:v1:BGFiYzEyMzQ1Njc4OTBhYmNkZWYxMjM0NTY3ODkwYWJjZGVmMTIzNDU2Nzg5MGFiY2RlZjEyMzQ1Njc4OTBhYmNkZWY=
```

### Command Line

```bash
morpheus env seal --name ANTHROPIC_API_KEY --value sk-ant-api03-xxx

# Or from stdin (for scripts)
echo "sk-ant-api03-xxx" | morpheus env seal --name ANTHROPIC_API_KEY --stdin
```

### Multiple Secrets

```bash
morpheus env seal --file .env.secrets

# .env.secrets format:
# ANTHROPIC_API_KEY=sk-ant-xxx
# OPENAI_API_KEY=sk-xxx
# DATABASE_URL=postgres://user:pass@host/db
```

## Step 2: Add to morpheus.yaml

```yaml
# morpheus.yaml
project:
  name: my-agent

template: ai-agent

env:
  # Public variables (not encrypted)
  NODE_ENV: production
  LOG_LEVEL: info

  # Sealed secrets (encrypted)
  ANTHROPIC_API_KEY: sealed:v1:BGFiYzEyMzQ1Njc4OTBhYmNkZWYxMjM0NTY3ODkwYWJjZGVmMTIzNDU2Nzg5MGFiY2RlZjEyMzQ1Njc4OTBhYmNkZWY=
  OPENAI_API_KEY: sealed:v1:AHh5ejEyMzQ1Njc4OTBhYmNkZWYxMjM0NTY3ODkwYWJjZGVmMTIzNDU2Nzg5MGFiY2RlZjEyMzQ1Njc4OTBhYmNkZWY=
```

## Step 3: Deploy

When you deploy, secrets are automatically decrypted:

```bash
morpheus deploy

# Output:
# Deployment Flow
# ───────────────
#
# [1/5] Processing environment...
#       Found 4 environment variables
#       Decrypting 2 sealed secrets...
#       ✓ All secrets decrypted
```

## Verifying Secrets

### List Environment Variables

```bash
morpheus env list

# Output:
# Environment Variables
# ─────────────────────
#
# Public:
#   NODE_ENV=production
#   LOG_LEVEL=info
#
# Sealed (encrypted):
#   ANTHROPIC_API_KEY=sealed:v1:*** (sealed)
#   OPENAI_API_KEY=sealed:v1:*** (sealed)
```

### Verify a Secret

```bash
morpheus env verify --name ANTHROPIC_API_KEY

# Output:
# ✓ Secret ANTHROPIC_API_KEY is valid
#   Encryption: ECIES (secp256k1)
#   Created: 2024-01-15T10:30:00Z
#   Preview: sk-ant-***
```

## Updating Secrets

### Replace a Secret

```bash
morpheus env seal --name ANTHROPIC_API_KEY --value sk-ant-new-key

# Then update morpheus.yaml with the new sealed value
```

### Rotate All Secrets

```bash
morpheus env rotate

# Output:
# Rotating secrets...
#
# ⚠ This will re-encrypt all secrets with a new key.
# Continue? [y/N] y
#
# ✓ ANTHROPIC_API_KEY rotated
# ✓ OPENAI_API_KEY rotated
#
# Updated morpheus.yaml with new sealed values.
```

## Understanding the Format

Sealed secrets follow this format:

```
sealed:v1:BASE64_ENCODED_CIPHERTEXT
│      │  │
│      │  └─ Encrypted data (ECIES ciphertext)
│      └─ Version number (for future format changes)
└─ Prefix identifier
```

### ECIES Details

The encryption uses:

- **Curve**: secp256k1 (same as Ethereum/Bitcoin)
- **Encryption**: AES-256-GCM
- **KDF**: HKDF-SHA256
- **MAC**: Built into GCM

This means secrets can only be decrypted by someone with your wallet's private key.

## API Reference

### CLI Commands

| Command               | Description                    |
| --------------------- | ------------------------------ |
| `morpheus env seal`   | Encrypt a secret               |
| `morpheus env unseal` | Decrypt a secret (debug only)  |
| `morpheus env list`   | List all environment variables |
| `morpheus env verify` | Verify a sealed secret         |
| `morpheus env rotate` | Re-encrypt all secrets         |

### Programmatic Usage

```typescript
import { sealSecret, unsealSecret } from '@morpheus-deploy/core';

// Seal a secret
const sealed = await sealSecret('my-api-key', publicKey);
console.log(sealed); // sealed:v1:...

// Unseal (requires private key)
const plaintext = await unsealSecret(sealed, privateKey);
console.log(plaintext); // my-api-key
```

## Security Best Practices

### 1. Never Commit Plaintext Secrets

```gitignore
# .gitignore

# Never commit these
.env
.env.local
.env.secrets
*.key

# Safe to commit (encrypted)
morpheus.yaml
```

### 2. Use Environment-Specific Secrets

```yaml
# morpheus.yaml (development)
env:
  API_KEY: sealed:v1:DEV_KEY_HERE...

# morpheus.production.yaml
env:
  API_KEY: sealed:v1:PROD_KEY_HERE...
```

### 3. Rotate Secrets Regularly

Set up a rotation schedule:

```bash
# Monthly rotation script
morpheus env rotate --force
git add morpheus.yaml
git commit -m "chore: rotate secrets"
```

### 4. Audit Secret Access

Check who can decrypt your secrets:

```bash
morpheus env audit

# Output:
# Secret Access Audit
# ──────────────────
#
# Encryption Key: 0x1a2B3c4D5e6F...
# Owner: you@example.com
#
# No delegated access configured.
# Only the wallet owner can decrypt secrets.
```

### 5. Use Different Keys per Environment

```bash
# Development wallet
morpheus --profile dev env seal --name API_KEY

# Production wallet
morpheus --profile prod env seal --name API_KEY
```

## Troubleshooting

### "Failed to decrypt secret"

Your wallet may have changed:

```bash
# Check which key encrypted the secret
morpheus env info --name ANTHROPIC_API_KEY

# Output:
# Secret: ANTHROPIC_API_KEY
# Encrypted by: 0x1a2B3c...
# Current wallet: 0x9f8E7d...
#
# ⚠ Key mismatch! Re-seal with current wallet:
# morpheus env seal --name ANTHROPIC_API_KEY --value YOUR_VALUE
```

### "Invalid sealed format"

The sealed value may be corrupted:

```bash
# Verify format
morpheus env verify --name ANTHROPIC_API_KEY

# If invalid, re-seal
morpheus env seal --name ANTHROPIC_API_KEY
```

### "Secret not found in deployment"

Ensure the secret is in `morpheus.yaml`:

```yaml
env:
  # Check this exists
  ANTHROPIC_API_KEY: sealed:v1:...
```

### Debugging Secrets Locally

For local debugging only:

```bash
# Temporarily unseal to verify value
morpheus env unseal --name ANTHROPIC_API_KEY

# ⚠ WARNING: This will print the secret to your terminal!
# Continue? [y/N] y
#
# ANTHROPIC_API_KEY=sk-ant-api03-xxx
```

<Callout type="warn">
  Never use `unseal` in production or CI/CD. It's only for local debugging.
</Callout>

## Migration from Other Secret Managers

### From .env Files

```bash
morpheus env import --from .env --seal

# Output:
# Importing from .env...
#
# Found 5 variables:
#   NODE_ENV=production (public, not sealing)
#   LOG_LEVEL=info (public, not sealing)
#   ANTHROPIC_API_KEY=sk-*** (sealing)
#   OPENAI_API_KEY=sk-*** (sealing)
#   DATABASE_URL=postgres://*** (sealing)
#
# ✓ Sealed 3 secrets
# ✓ Updated morpheus.yaml
```

### From GitHub Secrets

```bash
# Export from GitHub (you'll need the values)
gh secret list

# Then seal each one
morpheus env seal --name SECRET_NAME --value VALUE
```

## Next Steps

- [Auto Top-Up Configuration](/docs/guides/auto-topup)
- [GPU Deployments](/docs/guides/gpu-deployments)
- [Wallet Security](/docs/contracts/smart-wallet)
